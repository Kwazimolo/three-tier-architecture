# .github/workflows/security-workflow.yml

# name: Security Analysis

# on:
#   workflow_call:
#     inputs:
#       tool:
#         required: true
#         type: string
#         description: 'The IaC tool to analyse for security (terraform, cloudformation, opentofu)'
#     secrets:
#       AWS_ACCESS_KEY_ID:
#         required: true
#       AWS_SECRET_ACCESS_KEY:
#         required: true

# jobs:
#   analyse-security:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3
#         with:
#           ref: terraform # Branch name
        
#       - name: Setup Python
#         uses: actions/setup-python@v3
#         with:
#           python-version: '3.10'
          
#       - name: Setup AWS Credentials
#         uses: aws-actions/configure-aws-credentials@v2
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: eu-west-1
          
#       - name: Ensure results directory exists
#         run: |
#           mkdir -p results/security
      
#       - name: Install Checkov
#         run: |
#           pip install checkov
#           checkov --version
      
#       - name: Run Security Analysis
#         run: |
#           # Determine which directory to analyse
#           if [ "${{ inputs.tool }}" == "terraform" ]; then
#             IaC_DIR="infrastructure/terraform"
#             FRAMEWORK="terraform"
#           elif [ "${{ inputs.tool }}" == "opentofu" ]; then
#             IaC_DIR="infrastructure/openTofu"  # Note the capital 'T' in openTofu
#             FRAMEWORK="terraform" # Use terraform framework for OpenTofu
#           elif [ "${{ inputs.tool }}" == "cloudformation" ]; then
#             IaC_DIR="infrastructure/cloudformation"
#             FRAMEWORK="cloudformation"
#           fi
          
#           # Ensure the directory exists
#           if [ ! -d "$IaC_DIR" ]; then
#             echo "Warning: Directory $IaC_DIR not found"
#             mkdir -p $IaC_DIR
            
#             # Create minimal placeholder file based on framework
#             if [ "$FRAMEWORK" == "terraform" ]; then
#               echo "# Placeholder file" > $IaC_DIR/placeholder.tf
#             elif [ "$FRAMEWORK" == "cloudformation" ]; then
#               echo "{}" > $IaC_DIR/placeholder.json
#             fi
#           fi
          
#           # Run Checkov security checks with error handling
#           echo "Running security analysis for ${{ inputs.tool }} in $IaC_DIR..."
          
#           # Create empty JSON results in case Checkov fails
#           echo '{"results": {"passed_checks": [], "failed_checks": []}}' > results/security/${{ inputs.tool }}_aws_checks.json
#           echo '{"results": {"passed_checks": [], "failed_checks": []}}' > results/security/${{ inputs.tool }}_iam_checks.json
#           echo '{"results": {"passed_checks": [], "failed_checks": []}}' > results/security/${{ inputs.tool }}_network_checks.json
#           echo '{"results": {"passed_checks": [], "failed_checks": []}}' > results/security/${{ inputs.tool }}_encryption_checks.json
          
#           # AWS security best practices
#           checkov -d $IaC_DIR --framework $FRAMEWORK --check AWS --output json > results/security/${{ inputs.tool }}_aws_checks.json || true
          
#           # IAM security checks
#           checkov -d $IaC_DIR --framework $FRAMEWORK --check IAM --output json > results/security/${{ inputs.tool }}_iam_checks.json || true
          
#           # Network security checks
#           checkov -d $IaC_DIR --framework $FRAMEWORK --check NETWORKS --output json > results/security/${{ inputs.tool }}_network_checks.json || true
          
#           # Encryption checks
#           checkov -d $IaC_DIR --framework $FRAMEWORK --check ENCRYPTION --output json > results/security/${{ inputs.tool }}_encryption_checks.json || true
          
#           # Check if script exists with UK spelling and generate summary
#           if [ -f "scripts/analysers/security_analyser.py" ]; then
#             python scripts/analysers/security_analyser.py --tool ${{ inputs.tool }} \
#               --aws-checks results/security/${{ inputs.tool }}_aws_checks.json \
#               --iam-checks results/security/${{ inputs.tool }}_iam_checks.json \
#               --network-checks results/security/${{ inputs.tool }}_network_checks.json \
#               --encryption-checks results/security/${{ inputs.tool }}_encryption_checks.json \
#               --output results/security/${{ inputs.tool }}_security_report.json
#           else
#             # Create a minimal report since script doesn't exist
#             echo "{\"tool\": \"${{ inputs.tool }}\", \"overall\": {\"passed\": 0, \"failed\": 0, \"pass_percentage\": 0, \"security_score\": 50}}" > results/security/${{ inputs.tool }}_security_report.json
#           fi
    
#       - name: Upload Security Analysis Results
#         uses: actions/upload-artifact@v4
#         with:
#           name: security-results-${{ inputs.tool }}
#           path: results/security/

name: Security Analysis Workflow

on:
  workflow_call:
    inputs:
      tool:
        required: true
        type: string
        description: 'The IaC tool to analyse for security (terraform, cloudformation, opentofu)'
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: ${{ github.ref_name }}
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Determine Checkov Checks
      id: select-checks
      run: |
        if [ "${{ inputs.tool }}" == "cloudformation" ]; then
          # CloudFormation-specific checks
          CHECKOV_CHECKS="CKV_AWS_2,CKV_AWS_3,CKV_AWS_5,CKV_AWS_6,CKV_AWS_7,CKV_AWS_16,CKV_AWS_17,CKV_AWS_18,CKV_AWS_19,CKV_AWS_20,CKV_AWS_21,CKV_AWS_23,CKV_AWS_24,CKV_AWS_25,CKV_AWS_26,CKV_AWS_27,CKV_AWS_28,CKV_AWS_33,CKV_AWS_34,CKV_AWS_35,CKV_AWS_40,CKV_AWS_42,CKV_AWS_45,CKV_AWS_53,CKV_AWS_54,CKV_AWS_58,CKV_AWS_59,CKV_AWS_60,CKV_AWS_61,CKV_AWS_62,CKV_AWS_63"
        else
          # Terraform/OpenTofu checks
          CHECKOV_CHECKS="CKV_AWS_1,CKV_AWS_2,CKV_AWS_3,CKV_AWS_5,CKV_AWS_6,CKV_AWS_7,CKV_AWS_8,CKV_AWS_16,CKV_AWS_17,CKV_AWS_18,CKV_AWS_19,CKV_AWS_20,CKV_AWS_21,CKV_AWS_23,CKV_AWS_24,CKV_AWS_25,CKV_AWS_26,CKV_AWS_27,CKV_AWS_28,CKV_AWS_32,CKV_AWS_33,CKV_AWS_34,CKV_AWS_35,CKV_AWS_36,CKV_AWS_40,CKV_AWS_42,CKV_AWS_45,CKV_AWS_53,CKV_AWS_54,CKV_AWS_58,CKV_AWS_59,CKV_AWS_60,CKV_AWS_61,CKV_AWS_62,CKV_AWS_63"
        fi
        echo "checks=$CHECKOV_CHECKS" >> $GITHUB_OUTPUT
      
    - name: Run Checkov Security Scan
      id: checkov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: infrastructure/${{ inputs.tool }}
        output_format: json
        output_file: results/security/${{ inputs.tool }}_checkov_results.json
        check: ${{ steps.select-checks.outputs.checks }}
        skip_framework: dockerfile,secrets,helm,kustomize
        quiet: false
    
    - name: Analyse Security Findings
      run: |
        python scripts/analysers/security_analyser.py \
          --tool ${{ inputs.tool }} \
          --check-file results/security/${{ inputs.tool }}_checkov_results.json \
          --output results/security/${{ inputs.tool }}_security_report.json
    
    - name: Upload Security Reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ inputs.tool }}
        path: results/security/