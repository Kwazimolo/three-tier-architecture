# .github/workflows/setup-workflow.yml
name: Setup Environment

on:
  workflow_call:
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'
    
      - name: Setup Dependencies
        run: |
          # Check multiple possible locations
          if [ -f "requirements.txt" ]; then
            echo "Found requirements.txt in repository root"
            pip install -r requirements.txt
          elif [ -f "../../requirements.txt" ]; then
            echo "Found requirements.txt in relative path"
            pip install -r ../../requirements.txt
          else
            echo "requirements.txt not found, creating minimal version"
            # Create a minimal requirements.txt if it doesn't exist
            echo "# Dependencies for IaC Tools Evaluation" > requirements.txt
            echo "pytest==7.4.0" >> requirements.txt
            echo "pytest-cov==4.1.0" >> requirements.txt
            echo "pyyaml==6.0.1" >> requirements.txt
            echo "boto3==1.28.38" >> requirements.txt
            echo "awscli==1.29.38" >> requirements.txt
            echo "matplotlib==3.7.2" >> requirements.txt
            echo "pandas==2.0.3" >> requirements.txt
            pip install -r requirements.txt
          fi
    
      - name: Setup AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1
      
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.7'
      
      - name: Install OpenTofu
        run: |
          curl --proto '=https' --tlsv1.2 -fsSL https://get.opentofu.org/install-opentofu.sh -o install-opentofu.sh
          chmod +x install-opentofu.sh
          ./install-opentofu.sh --install-method standalone
          tofu --version
      
      - name: Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
          aws --version

      - name: Install Infracost
        run: |
          curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
          infracost --version
         
          
      - name: Create results directory structure
        run: |
          mkdir -p results/static-analysis
          mkdir -p results/deployment
          mkdir -p results/performance
          mkdir -p results/cost-analysis
          
      - name: Upload directory structure as artifact
        uses: actions/upload-artifact@v4
        with:
          name: results-structure
          path: results/
          